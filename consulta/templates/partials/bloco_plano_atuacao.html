{% load widget_tweaks %}


<section id="plano-atuacao" class="card shadow p-4 mb-4 rounded">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="section-title mb-0 text-primary">ğŸ“Œ Planos de AtuaÃ§Ã£o</h5>
    <button class="btn btn-sm btn-outline-success" onclick="toggleForm('formPlano')" title="Adicionar novo plano">
      â• Novo Plano
    </button>
  </div>

  <div id="formPlano" class="mb-3 d-none">
    <form method="POST" id="formPlanoForm" action="{% url 'adicionar_plano_atuacao' %}">
      {% csrf_token %}
      <input type="hidden" name="consulta_id" value="{{ consulta.id }}">
      <div class="row">
        {% for field in plano_form %}
        <div class="col-md-6 mb-3 {% if field.name in 'problema_saude medicamento relato_anamnese avaliacao' %}campo-relacao{% endif %}" 
             data-relacao="{{ field.name }}">
          <label class="form-label">{{ field.label }}</label>
          {{ field }}
          {% for error in field.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
        {% endfor %}
      </div>
      <div class="text-end">
        <button type="submit" class="btn btn-success btn-sm">ğŸ’¾ Salvar Plano</button>
      </div>
    </form>
  </div>

  {% if planos %}
  {% for plano in planos %}
  <div class="card shadow-sm border-start border-primary mb-3">
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h6 class="text-primary mb-2">
            {% if plano.avaliacao %}
              ğŸ“ AvaliaÃ§Ã£o: {{ plano.avaliacao }}
              {% if plano.avaliacao.medicamento %}
                | ğŸ’Š {{ plano.avaliacao.medicamento.nome }}
                {% if plano.avaliacao.medicamento.problema_saude %}
                  | ğŸ©º {{ plano.avaliacao.medicamento.problema_saude.problema }}
                {% endif %}
              {% endif %}
            
            {% elif plano.medicamento %}
              ğŸ’Š {{ plano.medicamento.nome }}
              {% if plano.medicamento.problema_saude %}
                | ğŸ©º {{ plano.medicamento.problema_saude.problema }}
              {% endif %}
            
            {% elif plano.problema_saude %}
              ğŸ©º {{ plano.problema_saude.problema }}
            
            {% elif plano.relato_anamnese %}
              ğŸ“ Relato: {{ plano.relato_anamnese|truncatechars:50 }}
            
            {% else %}
              â„¹ï¸ Nenhuma informaÃ§Ã£o vinculada.
            {% endif %}
          </h6>
          

          <ul class="list-unstyled">
            <li><strong>ğŸ¯ Objetivos:</strong> {{ plano.objetivos|default:"â€”" }}</li>
            <li><strong>ğŸ·ï¸ Prioridade:</strong> {{ plano.get_prioridade_display|default:"â€”" }}</li>
            <li><strong>ğŸ› ï¸ IntervenÃ§Ã£o:</strong> {{ plano.get_registro_intervencao_display|default:"â€”" }}</li>
            <li><strong>ğŸ“š ClassificaÃ§Ã£o:</strong> {{ plano.get_classificacao_intervencao_display|default:"â€”" }}</li>
            <li><strong>ğŸ“ DescriÃ§Ã£o:</strong> {{ plano.descricao_planejamento|default:"â€”" }}</li>
            <li><strong>ğŸ“… Data da IntervenÃ§Ã£o:</strong> {{ plano.data_intervencao|date:"Y-m-d"|default:"â€”" }}</li>
          </ul>
        </div>

        <div class="col-md-6 border-start ps-4">
          <h6 class="text-primary mb-2">ğŸ” Acompanhamento</h6>
          <ul class="list-unstyled">
            <li><strong>âœ… AlcanÃ§ado:</strong> {{ plano.alcancado|yesno:"Sim,NÃ£o,â€”" }}</li>
            <li><strong>ğŸ“† Data:</strong> {{ plano.data_alcancado|date:"d/m/Y"|default:"â€”" }}</li>
            <li><strong>ğŸ“Œ Resultado:</strong> {{ plano.resultado|default:"â€”" }}</li>
            <li><strong>ğŸ§© RNM Resolvido:</strong> {{ plano.rnm_resolvido|yesno:"Sim,NÃ£o,â€”" }}</li>
            <li><strong>ğŸ“ O que aconteceu:</strong> {{ plano.o_que_aconteceu|default:"â€”" }}</li>
          </ul>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-md-6 d-flex gap-2">
          <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="preencherFormularioPlano(this)"
            data-id="{{ plano.id }}"
            data-avaliacao="{{ plano.avaliacao.id|default_if_none:'' }}"
            data-objetivos="{{ plano.objetivos }}"
            data-prioridade="{{ plano.prioridade }}"
            data-registro="{{ plano.registro_intervencao }}"
            data-classificacao="{{ plano.classificacao_intervencao }}"
            data-descricao="{{ plano.descricao_planejamento }}"
            data-data="{{ plano.data_intervencao|date:'Y-m-d' }}">
            âœï¸ Editar Plano
          </button>

          <form method="POST" action="{% url 'excluir_objeto' 'plano' plano.id %}"
            onsubmit="return confirm('Tem certeza que deseja excluir este plano?');">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger btn-sm">ğŸ—‘ï¸</button>
          </form>
        </div>

        <div class="col-md-6 text-end">
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleAcompanhamento('{{ plano.id }}')">
            âœï¸ Editar Acompanhamento
          </button>
        </div>
      </div>

      <form method="POST" id="formAcompanhamento{{ plano.id }}" action="{% url 'atualizar_acompanhamento' plano.id %}"
        class="bg-light p-3 rounded d-none mt-3">
        {% csrf_token %}
        <div class="row">
          {% for field in plano.acompanhamento_form %}
          <div class="col-md-6 mb-3">
            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field }}
            {% for error in field.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
          {% endfor %}
        </div>
        <div class="text-end">
          <button type="submit" class="btn btn-success btn-sm">ğŸ’¾ Salvar Acompanhamento</button>
        </div>
      </form>
    </div>
  </div>
  {% endfor %}
  {% else %}
  <p class="text-muted">Nenhum plano registrado para esta consulta.</p>
  {% endif %}
</section>

<script>
  document.getElementById('id_tipo_relacao').addEventListener('change', function () {
    const selected = this.value;

    document.querySelectorAll('.campo-relacao').forEach(function (field) {
      if (field.dataset.relacao === selected) {
        field.closest('.mb-3').classList.remove('d-none');
      } else {
        field.closest('.mb-3').classList.add('d-none');
      }
    });
  });

  window.addEventListener('load', function () {
    const selected = document.getElementById('id_tipo_relacao').value;
    document.querySelectorAll('.campo-relacao').forEach(function (field) {
      if (field.dataset.relacao === selected) {
        field.closest('.mb-3').classList.remove('d-none');
      } else {
        field.closest('.mb-3').classList.add('d-none');
      }
    });
  });

  function preencherFormularioPlano(btn) {
    const formDiv = document.getElementById('formPlano');
    const form = document.getElementById('formPlanoForm');
    formDiv.classList.remove('d-none');

    document.getElementById('id_avaliacao').value = btn.dataset.avaliacao;
    document.getElementById('id_objetivos').value = btn.dataset.objetivos;
    document.getElementById('id_prioridade').value = btn.dataset.prioridade;
    document.getElementById('id_registro_intervencao').value = btn.dataset.registro;
    document.getElementById('id_classificacao_intervencao').value = btn.dataset.classificacao;
    document.getElementById('id_descricao_planejamento').value = btn.dataset.descricao;
    document.getElementById('id_data_intervencao').value = btn.dataset.data;

    form.action = `/consulta/editar/plano/${btn.dataset.id}/`;
  }

  function toggleAcompanhamento(planoId) {
    const form = document.getElementById(`formAcompanhamento${planoId}`);
    form.classList.toggle('d-none');
  }
</script>
